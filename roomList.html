<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Listing</title>
    <!-- Bootstrap CSS -->
    <link href="node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="assets/fontawesome-pro-5.15.4/css/all.css" rel="stylesheet">
    <!-- AOS CSS -->
    <link href="node_modules/aos/dist/aos.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="assets/css/styles.css" rel="stylesheet">
</head>

<body>

    <!-- Room List Container -->
    <div class="row" id="roomList">
        <!-- Rooms will be dynamically loaded here -->
    </div>


    <!-- Room Card Template -->
    <template id="roomCardTemplate">
        <div class="col-md-6 col-lg-12 mb-4">
            <div class="card h-100 shadow-sm p-0" data-aos="fade-up" data-aos-delay="100">
                <div class="card-body">
                    <h5 class="card-title mb-3"><small class="description text-muted mb-3"></small></h5>


                    <div class="room-info mb-3" style="font-size: 14px;">
                        <p><i class="fas fa-door-open me-2"></i><span class="building"></span>.<span
                                class="room-number"></span>
                            <span class="float-end"><i class="fas fa-users me-2"></i>Capacity: <span
                                    class="capacity-number"></span></span>
                        </p>
                    </div>

                    <div class="amenities">
                        <h6 class="mb-2">Amenities</h6>
                        <div class="amenity-icons d-flex flex-wrap gap-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- jQuery -->
    <script src="node_modules/jquery/dist/jquery.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <!-- AOS JS -->
    <script src="node_modules/aos/dist/aos.js"></script>
    <!-- SweetAlert2 JS -->
    <script src="node_modules/sweetalert2/dist/sweetalert2.min.js"></script>

    <script>
        $(document).ready(() => {
            // Initialize AOS
            AOS.init();

            // Cache for amenity data
            const amenityCache = new Map();

            // Function to fetch amenity details
            const fetchAmenityDetails = async (amenityId) => {
                if (amenityCache.has(amenityId)) {
                    return amenityCache.get(amenityId);
                }

                try {
                    const response = await $.ajax({
                        url: `assets/cfc/amenity.cfc?method=getAmenity&amenityId=${amenityId}`,
                        method: 'GET',
                        dataType: 'json'
                    });

                    if (response && response.data) {
                        const amenityData = {
                            id: response.data.id,
                            name: response.data.name,
                            description: response.data.description,
                            icon: response.data.icon
                        };
                        amenityCache.set(amenityId, amenityData);
                        return amenityData;
                    }
                    console.error('Invalid amenity response for ID:', amenityId);
                    return null;
                } catch (error) {
                    console.error(`Error fetching amenity ${amenityId}:`, error);
                    return null;
                }
            };

            // Function to create amenity icons
            const createAmenityIcons = async (amenityIds) => {
                console.log('Creating icons for amenities:', amenityIds);
                if (!Array.isArray(amenityIds)) {
                    console.error('Invalid amenityIds:', amenityIds);
                    return '';
                }

                // Fetch all amenity details in parallel
                const amenityPromises = amenityIds.map(id => fetchAmenityDetails(id));
                const amenityDetails = await Promise.all(amenityPromises);
                console.log('Fetched amenity details:', amenityDetails);

                const icons = amenityDetails
                    .filter(amenity => amenity !== null)
                    .map(amenity => {
                        console.log('Creating icon for amenity:', amenity);
                        return `<i class="fas ${amenity.icon}" 
                                 data-bs-toggle="popover" 
                                 data-bs-trigger="hover focus"
                                 data-bs-placement="top"
                                 data-bs-title="${amenity.name}"
                                 data-bs-content="${amenity.description}"
                                 style="cursor: pointer;"></i>`;
                    })
                    .join(' ');

                console.log('Generated icons HTML:', icons);
                return icons;
            };

            // Function to format time
            const formatTime = (date) => {
                return date.toLocaleTimeString('en-US', {
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });
            };
            const loadRomAmenities = (RoomId) => {
                //fetch room amenities from database
                $.ajax({
                    url: 'assets/cfc/amenity.cfc',
                    type: 'GET',
                    dataType: 'json',
                    data: {
                        method: 'getRoomAmenities',
                        roomId: selectedRoom
                    },
                    success: function (response) {
                        if (response) {
                            var html = '';
                            for (let i = 0; i < response.length; i++) {
                                html += "<i class='fas " + response[i].icon + " fa-2x me-2' data-amenity-id='" + response[i].id + "' data-bs-toggle='tooltip' data-bs-placement='bottom' title='" + response[i].name + "'></i>";
                            }
                            $(".amentiesContainer").html(html);
                            // Initialize tooltips
                            $('[data-bs-toggle="tooltip"]').tooltip();
                        } else {
                            $('#amentiesContainer').html('');
                        }

                    },
                    error: function (xhr, status, error) {
                        console.error('Error loading room amenities:', error);
                    }
                });
            }
            // Function to create room cards
            const createRoomCard = async (room) => {
                console.log('Creating card for room:', room);

                const template = document.getElementById('roomCardTemplate');
                const clone = document.importNode(template.content, true);
                const card = $(clone);

                // Set room details
                card.find('.card-title').text(room.roomName);
                card.find('.building').text(room.building);
                card.find('.room-number').text(room.roomNumber);
                card.find('.capacity-number').text(room.capacity);
                card.find('.description').text(room.description);

                // Set amenities
                if (room.amenities && room.amenities.length > 0) {
                    console.log('Room amenities:', room.amenities);
                    const amenityIcons = await createAmenityIcons(room.amenities);
                    console.log('Generated icons:', amenityIcons);
                    const amenityContainer = card.find('.amenity-icons');
                    amenityContainer.html(amenityIcons);

                    // Initialize popovers
                    setTimeout(() => {
                        amenityContainer.find('[data-bs-toggle="popover"]').popover({
                            html: true,
                            container: 'body'
                        });
                    }, 0);
                } else {
                    card.find('.amenities').hide();
                }

                // Set status badge and booking information
                const badge = card.find('.status-badge');
                const bookBtn = card.find('.book-btn');
                const timeBlock = card.find('.time-block');
                const currentBooking = card.find('.current-booking');
                const progressBar = card.find('.progress-bar');

                if (room.status === 'Available') {
                    badge.addClass('bg-success').text('Available');
                    bookBtn.show();
                    currentBooking.html('<span class="text-success">Available Now</span>');
                    progressBar.addClass('bg-success').css('width', '100%');

                    // Add click handler for booking
                    bookBtn.on('click', () => {
                        Swal.fire({
                            title: 'Book Room',
                            html: `
                                <div class="mb-3">
                                    <label class="form-label">Start Time</label>
                                    <input type="datetime-local" id="startTime" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">End Time</label>
                                    <input type="datetime-local" id="endTime" class="form-control">
                                </div>
                            `,
                            showCancelButton: true,
                            confirmButtonText: 'Book Room',
                            showLoaderOnConfirm: true,
                            preConfirm: () => {
                                const startTime = document.getElementById('startTime').value;
                                const endTime = document.getElementById('endTime').value;

                                if (!startTime || !endTime) {
                                    Swal.showValidationMessage('Please select both start and end times');
                                    return false;
                                }

                                return { startTime, endTime };
                            }
                        }).then((result) => {
                            if (result.isConfirmed) {
                                // TODO: Implement booking functionality
                                Swal.fire('Booked!', 'Room has been booked successfully.', 'success');
                                loadRooms(); // Refresh the room list
                            }
                        });
                    });
                } else {
                    badge.addClass('bg-danger').text('Occupied');
                    currentBooking.html('<span class="text-danger">Currently In Use</span>');
                    progressBar.addClass('bg-danger').css('width', '100%');
                }

                return card;
            };

            // Fetch and display rooms
            const loadRooms = async () => {
                console.log('Loading rooms...');
                try {
                    const response = await $.ajax({
                        url: 'assets/cfc/room.cfc?method=getRooms',
                        method: 'GET',
                        dataType: 'json'
                    });
                    console.log('Rooms response:', response);

                    const roomList = $('#roomList');
                    roomList.empty();

                    if (response && response.rooms) {
                        // Create all room cards in parallel
                        const cardPromises = response.rooms.map(room => createRoomCard(room));
                        const cards = await Promise.all(cardPromises);
                        cards.forEach(card => roomList.append(card));
                    } else {
                        console.error('Invalid rooms response:', response);
                    }
                } catch (error) {
                    console.error('Error loading rooms:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Failed to load rooms. Please try again later.'
                    });
                }
            };

            // Initial load
            loadRooms();

            // Cleanup popovers before refresh
            const cleanupPopovers = () => {
                $('[data-bs-toggle="popover"]').popover('dispose');
            };

            // Refresh every 5 minutes
            setInterval(() => {
                cleanupPopovers();
                loadRooms();
            }, 300000);
        });
    </script>

    <style>
        .card {
            transition: transform 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .room-info p {
            margin-bottom: 0.5rem;
        }

        .room-info i {
            width: 20px;
            color: #6c757d;
        }

        .status-badge {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
        }

        .description {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .amenity-icons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.03);
            border-radius: 0.5rem;
            margin-top: 0.5rem;
        }

        .amenity-icons i {
            font-size: 1.2rem;
            color: #495057;
            padding: 0.5rem;
            border-radius: 0.5rem;
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }

        .amenity-icons i:hover {
            color: #0d6efd;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Custom Popover Styling */
        .popover {
            max-width: 300px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .popover-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            font-weight: 600;
        }

        .popover-body {
            padding: 0.75rem;
            color: #495057;
        }
    </style>
</body>

</html>