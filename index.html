<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DoCM Office Space Reservation Calendar</title>
    <!---add favicon-->
    <link rel="icon" type="image/x-icon" href="assets/images/favicon.png">

    <!-- CSS Dependencies -->
    <link href="node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/fontawesome-pro-5.15.4/css/all.css" rel="stylesheet">
    <!-- AOS CSS -->
    <link href="node_modules/aos/dist/aos.css" rel="stylesheet">
    <link href="assets/css/styles.css" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/site_tutorial.css">
    <link href="node_modules/sweetalert2/dist/sweetalert2.min.css" rel="stylesheet">
    <!-- Datetime picker styles removed -->
    <link rel="stylesheet" href="assets/fontawesome-pro-5.15.4/css/all.css">
    <!-- Datetime picker scripts removed -->
    <link rel="stylesheet" href="assets/css/datetime-picker.css">
    <!-- Note: booking_datetime.js is no longer used - datetime picker functionality is now directly in this file -->

    <style>
        /* .navbar {
            padding: 1rem;
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .navbar-brand img {
            height: 40px;
        } */
        .flatpickr-confirm {
            background: #4676e5;
            color: white;
        }

        .dashboard-card {
            background-color: azure;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }

        .dashboard-bg {
            background: rgb(14, 29, 68);
            opacity: 0.5;
            z-index: -1;
        }

        .card-icon {
            font-size: 24px;
            margin-right: 1rem;
        }

        .card-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }

        .upcoming-bookings {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        #upcomingBookings {
            min-height: 600px;
            margin: 1em 0;
            padding: 0;
            width: 100%;
            position: relative;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
        }

        .fc {
            /* the calendar root */
            max-width: 100%;
            height: 100%;
        }

        .btn-new-booking {
            background: #4F46E5;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            text-decoration: none;
        }

        .btn-new-booking:hover {
            background: #4338CA;
            color: white;
            border-color: white;
        }

        .btn-user-topNav {
            border: 1px solid #4F46E5;
            color: #4F46E5;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            text-decoration: none;
        }

        .btn-user-topNav:hover {
            background: #4338CA;
            color: white;
            border-color: white;

        }

        .btn-admin-topNav {
            border: 1px solid #ffffff;
            color: #ffffff;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            text-decoration: none;
        }

        .btn-admin-topNav:hover {
            background: #bbbabe;
            color: rgb(0, 0, 0);
            border-color: #2d2b3b;
        }

        .welcome-container {
            background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .welcome-title {
            color: #4338CA;
            font-size: 1.50rem;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .welcome-title i {
            font-size: 1.5rem;
            opacity: 0.9;
        }

        .notification-icon {
            position: relative;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #EF4444;
            color: white;
            border-radius: 50%;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        .booking-time {
            min-width: 200px;
        }

        .calendar-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            min-height: 600px;
        }

        .fc {
            /* the calendar root */
            max-width: 100%;
            margin: 0 auto;
        }

        /* Calendar event styling */
        .fc-event {
            cursor: pointer !important;
            border-radius: 4px !important;
            padding: 4px 6px !important;
            margin: 1px 0 !important;
            border: none !important;
            transition: all 0.3s ease !important;
            color: white !important;
            min-height: 45px !important;
        }

        /* Status indicators - only opacity and border */
        .booking-status-pending {
            opacity: 0.7;
            border-left: 4px solid #FFC107 !important;
        }

        .booking-status-approved {
            opacity: 1;
            border-left: 4px solid #4CAF50 !important;
        }

        .booking-status-rejected {
            opacity: 0.5;
            text-decoration: line-through;
            border-left: 4px solid #F44336 !important;
        }

        .fc-event:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .fc-event-title {
            font-weight: 500 !important;
            font-size: 0.85em !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            padding: 2px 0 !important;
            color: white !important;
            line-height: 1.2 !important;
        }

        .fc-event-time {
            font-size: 0.75em !important;
            opacity: 0.9 !important;
            font-weight: normal !important;
            color: white !important;
            white-space: nowrap !important;
            overflow: hidden !important;
        }

        /* Status indicator dot */
        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 4px;
        }

        .status-dot-pending {
            background-color: #FFC107;
        }

        .status-dot-approved {
            background-color: #4CAF50;
        }

        .status-dot-rejected {
            background-color: #F44336;
        }

        /* Different colors for 16 different rooms and 3 different conference rooms */
        .fc-event[data-room="Focus Room 1"] {
            background: linear-gradient(45deg, #2ecc71, #27ae60) !important;
        }

        .fc-event[data-room="Focus Room 2"] {
            background: linear-gradient(45deg, #3498db, #2980b9) !important;
        }

        .fc-event[data-room="Focus Room 3"] {
            background: linear-gradient(45deg, #e67e22, #d35400) !important;
        }

        .fc-event[data-room="Focus Room 4"] {
            background: linear-gradient(45deg, #9b59b6, #8e44ad) !important;
        }

        .fc-event[data-room="Focus Room 5"] {
            background: linear-gradient(45deg, #e74c3c, #c0392b) !important;
        }

        .fc-event[data-room="Focus Room 6"] {
            background: linear-gradient(45deg, #f1c40f, #f39c12) !important;
        }

        .fc-event[data-room="Focus Room 7"] {
            background: linear-gradient(45deg, #34495e, #2c3e50) !important;
        }

        .fc-event[data-room="Focus Room 8"] {
            background: linear-gradient(45deg, #1abc9c, #16a085) !important;
        }

        .fc-event[data-room="Focus Room 9"] {
            background: linear-gradient(45deg, #f39c12, #e67e22) !important;
        }

        .fc-event[data-room="Focus Room 10"] {
            background: linear-gradient(45deg, #9b59b6, #8e44ad) !important;
        }

        .fc-event[data-room="Focus Room 11"] {
            background: linear-gradient(45deg, #e74c3c, #c0392b) !important;
        }

        .fc-event[data-room="Focus Room 12"] {
            background: linear-gradient(45deg, #f1c40f, #f39c12) !important;
        }

        .fc-event[data-room="Focus Room 13"] {
            background: linear-gradient(45deg, #34495e, #2c3e50) !important;
        }

        .fc-event[data-room="Focus Room 14"] {
            background: linear-gradient(45deg, #1abc9c, #16a085) !important;
        }

        .fc-event[data-room="Focus Room 15"] {
            background: linear-gradient(45deg, #f39c12, #e67e22) !important;
        }

        .fc-event[data-room="Focus Room 16"] {
            background: linear-gradient(45deg, #9b59b6, #8e44ad) !important;
        }

        .fc-event[data-room="Meeting Room"],
        .fc-event[data-room*="Meeting"] {
            background: linear-gradient(45deg, #2ecc71, #27ae60) !important;
        }

        .fc-event[data-room="Library"] {
            background: linear-gradient(45deg, #9b59b6, #8e44ad) !important;
        }

        .fc-event[data-room*="Conference"],
        .fc-event[data-room*="Conference Room"] {
            background: linear-gradient(45deg, #e74c3c, #c0392b) !important;
        }

        /* Improved form controls */
        .form-control:focus {
            border-color: #4F46E5;
            box-shadow: 0 0 0 0.25rem rgba(79, 70, 229, 0.25);
        }

        /* Better spacing for form elements */
        .form-label {
            margin-bottom: 0.5rem;
        }

        /* Ensure proper spacing in the amenities section */
        .amenities-section {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* Make sure the image container maintains aspect ratio */
        .object-fit-cover {
            object-fit: cover;
            object-position: center;
        }


        .fc-toolbar-title {
            font-size: 1.2em !important;
            font-weight: 600;
        }

        .fc-button-primary {
            background-color: #0d6efd !important;
            border-color: #0d6efd !important;
            text-transform: capitalize !important;
            font-weight: 500 !important;
        }

        .fc-button-primary:hover {
            background-color: #0b5ed7 !important;
            border-color: #0a58ca !important;
        }

        /* Calendar header styling */
        .fc-col-header-cell {
            background-color: #f8f9fa !important;
            padding: 8px 0 !important;
        }

        .fc-timegrid {
            text-align: center !important;
            color: #495057 !important;
        }

        .fc-col-header-cell-cushion {
            color: #495057 !important;
            text-decoration: none !important;
            font-weight: 600 !important;
        }

        /* Today highlight */
        .fc-day-today {
            background-color: rgba(13, 110, 253, 0.05) !important;
        }

        .user-profile-section {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
            margin-bottom: 2rem;
        }

        .user-profile-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .user-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: #4F46E5;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
            margin-right: 1rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .user-details h2 {
            margin: 0;
            font-size: 1.25rem;
            color: #1F2937;
        }

        .user-details p {
            margin: 0;
            color: #6B7280;
            font-size: 0.875rem;
        }

        .user-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #E5E7EB;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #4F46E5;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #6B7280;
        }

        /*create a frosted glass effect*/
        .frosted-glass {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
            /* margin-bottom: 2rem; */
            position: relative;
            height: 100vh;
            overflow-y: auto;
        }

        #roomImageContainer {
            margin: 1rem 0;
            text-align: center;
            transition: opacity 0.3s ease;
        }

        #selectedRoomImage {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }

        #selectedRoomImage.loaded {
            opacity: 1;
        }
    </style>
</head>


<body class="bg-light">
    <!-- Navigation -->
    <div id="topNav"></div>

    <!--- Offcanvas --->
    <div class="offcanvas offcanvas-end" data-bs-backdrop="static" tabindex="-1" id="offcanvasExample"
        aria-labelledby="offcanvasExampleLabel">
        <div class="offcanvas-header">
            <h4 class="offcanvas-title d-flex align-items-center justify-content-center" id="offcanvasExampleLabel">
                USER GUIDE
            </h4>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>

        <div class="offcanvas-body">
            <div class="mb-3 mt-0">
                <button id="downloadUserGuide" class="btn btn-primary w-100 text-uppercase"><i
                        class="fal fa-file-download"></i> COMPLETE User Guide</button>
            </div>
            <div class="mb-3">
                <h4>TABLE OF CONTENTS</h4>
                <ul>
                    <li><a href="#welcome">Welcome Message</a></li>
                    <li><a href="#overview">Overview</a></li>
                    <li><a href="#it-assistance">IT Assistance</a></li>
                    <li><a href="#bookings">Making a Booking</a></li>
                    <li><a href="#booking-history">Viewing Booking History</a></li>
                    <li><a href="#calendar">Using the Calendar</a></li>
                    <li><a href="#cancel-booking">Cancel a Booking</a></li>
                </ul>
            </div>
            <div id="welcome">
                <h5>Welcome Message</h5>
                <p>Welcome to the DoCM Office Space Reservation Calendar. Use this tool to manage your room bookings
                    efficiently and stay organized.</p>
            </div>
            <div id="overview">
                <h5>Overview</h5>
                <p>This page allows you to view available office spaces, reserve rooms, and manage your bookings using a
                    calendar interface.</p>
            </div>
            <div id="it-assistance">
                <h5>IT Assistance</h5>
                <p>The Division of Cancer Medicine maintains the DoCM Reservation System. If you have any questions or
                    concerns regarding
                    DoCM Reservation System, Contact information: 4-INFO Call Center at ext. 713-794-4636 or email
                    4info@mdanderson.org</p>
            </div>
            <div id="bookings">
                <h5>Making a Booking</h5>
                <ul>
                    <li>Click the "New Booking" button in the top-right corner to open the booking form.</li>
                    <li>Select a room from the dropdown menu.</li>
                    <li>Enter the start and end times for your booking.</li>
                    <li>Optionally, select a recurring schedule (daily, weekly, or monthly).</li>
                    <li>Click "Book Room" to finalize your booking.</li>
                </ul>
            </div>
            <div id="booking-history">
                <h5>Viewing Booking History</h5>
                <ul>
                    <li>Navigate to the "My Bookings" section from the top navigation bar.</li>
                    <li>View all your past and upcoming bookings.</li>
                    <li>Click on any booking to see detailed information.</li>
                </ul>
            </div>
            <div id="calendar">
                <h5>Using the Calendar</h5>
                <ul>
                    <li>View bookings for all rooms or filter by specific rooms using the dropdown menu.</li>
                    <li>Click on a booking to view details or manage it (if you are the creator or an admin).</li>
                    <li>Navigate through different calendar views: day, week, or month.</li>
                    <li>Hover over bookings to see quick details in a tooltip.</li>
                </ul>
            </div>
            <div id="cancel-booking">
                <h5>Cancel a Booking</h5>
                <ul>
                    <li>Click on the booking in on the calendar to cancel it.</li>
                    <li>Confirm the cancellation by clicking "Yes, Cancel" in the modal.</li>
                    <li> The booking will be removed from the calendar and you will be notified of the cancellation.
                    </li>
                </ul>
            </div>
        </div>
    </div>



    <!-- Main Content -->
    <div class="container">

        <!-- Calendar Section -->
        <div class="upcoming-bookings frosted-glass">
            <div class="row">

                <div class="col-md-12">

                    <div class="d-flex justify-content-between align-items-center row">
                        <div class="row w-100">
                            <div class="col-4">
                                <div class=" gap-3">
                                    <h2 class="text-uppercase fw-bold text-white mb-0">Reserved Rooms</h2>
                                </div>
                            </div>
                            <div class="col-3">
                                <select id="roomFilter" class="form-select" style="width: auto; min-width: 150px;">
                                    <option value="">All Rooms</option>
                                </select>
                            </div>
                            <div class="col-2">
                                <!---add tooltip -->
                                <button class="btn btn-primary" id="officeMap" data-bs-toggle="tooltip"
                                    data-bs-placement="bottom" data-bs-title="Open FC11 Floor Map"><i
                                        class="fas fa-map"></i></button>
                            </div>
                            <div class="col-3">
                                <button class="btn-new-booking float-end">
                                    <i class="fas fa-plus me-2"></i>New Booking
                                </button>
                            </div>
                        </div>

                    </div>

                    <div id="upcomingBookings" class="calendar-containe p-3 rounded"></div>
                </div>

            </div>
        </div>

        <!-- Office Map Modal -->
        <div class="modal fade" id="officeMapModal" tabindex="-1" aria-labelledby="officeMapModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title text-uppercase" id="officeMapModalLabel">FC11 Office Map</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <img id="officeMapImage" src="assets/images/maps/FC11-Map.png" class="img-fluid"
                            alt="Office Map">
                    </div>
                </div>
            </div>
        </div>
        <!-- Room Booking Modal -->
        <div class="modal fade" id="bookingModal" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content border-0 shadow-sm">
                    <div class="modal-header bg-primary text-dark">
                        <h5 class="modal-title text-dark">
                            <i class="fas fa-calendar-check me-2"></i>Reserve a Focus Room
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    <form id="bookingForm" class="needs-validation" novalidate>
                        <div class="modal-body p-2 bg-light bg-gradient">

                            <!-- Room Selection Section -->


                            <div class="row">
                                <div class="col-4">
                                    <div class="card shadow-sm">
                                        <label for="roomSelect" class="form-label"><i class="fas fa-door-open"></i>
                                            Select
                                            Room</label>
                                        <select class="form-select" id="roomSelect" name="roomSelect" required>
                                            <option value="">Choose a room...</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="card shadow-sm" style="min-height: 136px;">
                                        <div class="card-body">
                                            <label class="form-label mb-0" style=" vertical-align: top;"><i
                                                    class="fas fa-map-signs"></i>
                                                Location</label>
                                            <div id="locationContainer" class="fw-bold text-center"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="card shadow-sm" style="min-height: 136px;">
                                        <div class="card-body">
                                            <label class="form-label mb-0"><i class="fas fa-users"></i>
                                                Capacity</label>
                                            <div id="capacityContainer" class="fw-bold text-center"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-2">
                                    <div class="card shadow-sm" style="min-height: 136px;">
                                        <div class="card-body d-flex justify-content-center align-items-center">
                                            <span id="roomMapContainer" class="btn btn-primary btn-sm"><i
                                                    class="fas fa-map"></i></span>
                                        </div>
                                    </div>
                                </div>
                            </div>


                            <!-- Room Details Section -->
                            <div class="row">
                                <div class="col-md-6">

                                    <!-- <div class="card h-25 border-0 shadow-sm p-0">
                                        <div class="card-body">
                                            <i class="fas fa-info-circle me-1"></i>Description
                                            <div class="description-box bg-light rounded mb-2">
                                                <span id="descriptionContainer" class="text-dark small h-100"></span>
                                            </div>
                                        </div>
                                    </div> -->
                                    <div class="card border-0 shadow-sm p-0">
                                        <div class="card-body">

                                            <h6 class="card-title mb-3">
                                                <i class="fas fa-clock me-1"></i>Booking Time
                                            </h6>
                                            <div class="row g-3">
                                                <div class="col-md">
                                                    <div id="start-picker"></div>
                                                    <input type="hidden" id="startTime" name="startTime">
                                                </div>
                                            </div>
                                            <div class="row g-3">
                                                <div class="col-md">
                                                    <div id="end-picker"></div>
                                                    <input type="hidden" id="endTime" name="endTime">
                                                </div>
                                            </div>

                                            <div class="row g-2">
                                                <div class="col-md-12">
                                                    <div id="recurringDetailsContainer">
                                                        <label for="recurringDetails" class="form-label mb-1">Recurring
                                                            Schedule</label>
                                                        <select class="form-select" id="recurringDetails">
                                                            <option value="">No recurring</option>
                                                            <option value="daily">Daily</option>
                                                            <option value="weekly">Weekly</option>
                                                            <option value="monthly">Monthly</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                    <!-- Room Amenities Card -->
                                    <div class="card border-0 shadow-sm mb-3 p-0">
                                        <div class="card-body p-3">
                                            <div class="amenities-section">
                                                <h6 class="card-title mb-3">
                                                    <i class="fas fa-building me-2"></i>Room Amenities
                                                </h6>
                                                <div class="amentiesContainer d-flex flex-wrap gap-2"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Meeting Title Card (Hidden by default) -->
                                    <div id="titleContainer" class="card border-0 shadow-sm d-none p-0">
                                        <div class="card-body p-3">
                                            <h6 class="card-title mb-3">
                                                <i class="fas fa-heading me-2"></i>Meeting Details
                                            </h6>
                                            <div class="mb-3">
                                                <label for="bookingTitle" class="form-label fw-medium">
                                                    Title / Purpose
                                                </label>
                                                <textarea class="form-control" id="bookingTitle" rows="2"
                                                    placeholder="Enter meeting title or purpose"
                                                    style="min-height: 80px;"></textarea>
                                                <div class="form-text text-muted small mt-1">
                                                    Required for non-focus room bookings
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div id="roomImageContainer" class="h-100 d-flex flex-column">
                                        <div class="flex-grow-1 overflow-hidden rounded-2 mb-2"
                                            style="min-height: 300px; max-height: 400px;">
                                            <img id="selectedRoomImage" class="img-fluid w-100 h-100 object-fit-cover"
                                                src="assets/images/officePlaceholder.png" alt="Room Image">
                                        </div>
                                        <div id="descriptionContainer" class="text-muted small mt-2"></div>
                                        <input type="hidden" id="currentImage" value="">
                                    </div>
                                </div>
                            </div>

                        </div>
                        <div class="modal-footer bg-light">
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-1"></i>Cancel
                            </button>
                            <button type="button" class="btn btn-primary" id="saveBooking">
                                <i class="fas fa-check me-1"></i>Book Room
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>



    </div>

    <!-- JavaScript Dependencies -->
    <script src="node_modules/jquery/dist/jquery.min.js"></script>
    <script src="node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="node_modules/sweetalert2/dist/sweetalert2.min.js"></script>
    <!-- FullCalendar JS -->
    <script src='assets/fullcalendar-6.1.15/dist/index.global.js'></script>
    <script src='assets/js/session-timeout.js'></script>
    <!-- AOS JS -->
    <script src="node_modules/aos/dist/aos.js"></script>
    <!-- Custom DateTime Picker -->
    <script src="assets/js/datetime_picker.js"></script>

    <script>
        // Function to format date for ColdFusion - placed in global scope for accessibility
        function formatDateForColdFusion(isoString) {
            if (!isoString) return '';

            const date = new Date(isoString);

            // Format as YYYY-MM-DD HH:mm AM/PM (exact format required by server)
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');

            let hours = date.getHours();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; // Convert 0 to 12

            const minutes = String(date.getMinutes()).padStart(2, '0');

            return `${year}-${month}-${day} ${hours}:${minutes} ${ampm}`;
        }

        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
        AOS.init();
        $(document).ready(function () {
            // Initialize tooltips
            $('[data-bs-toggle="tooltip"]').tooltip();

            var emplid = sessionStorage.getItem('EMPLID');
            $('#help_emplid').val(emplid)

            $('#officeMap').on('click', function () {
                $('#officeMapModal').modal('show');
            });

            //cleanupCalendar();
            // Load top navigation
            if (sessionStorage.getItem('ROLE') == 'Admin' || sessionStorage.getItem('ROLE') == 'Site Admin') {
                $('#topNav').load('topNav-Admin.html');
                $('.fa-bug').attr('data-bs-title', 'Staging');
                $('#downloadUserGuide').click(function () {
                    window.open('DoCM_Admin_Reservation_Help_Guide.pdf', '_blank');
                });
            } else {
                $('#topNav').load('topNav-User.html');
                $('.fa-bug').attr('data-bs-title', 'Staging');
                $('#downloadUserGuide').click(function () {
                    window.open('DoCM_User_Reservation_Help_Guide.pdf', '_blank');
                });
            }
            $('#myBookingsLink').on('click', function (e) {
                e.preventDefault();
                showMyBookings();
            });


            checkUserRole();
            $('#roomListContainer').load('roomList.html');

            const timeValidation = {
                roundToInterval: date => {
                    const minutes = Math.ceil(date.getMinutes() / 15) * 15;
                    return new Date(date.setMinutes(minutes, 0, 0));
                },

                showError: (title, text) => {
                    return Swal.fire({
                        icon: 'error',
                        title,
                        text,
                        confirmButtonClass: 'btn btn-primary'
                    });
                },

                validateTimeRange: ($input) => {
                    const $startTime = $('#startTime');
                    const $endTime = $('#endTime');
                    const currentTime = new Date();
                    const selectedTime = new Date($input.val());
                    const startTime = new Date($startTime.val());
                    const endTime = new Date($endTime.val());
                    const isStartTime = $input.data('timeType') === 'start';
                    const isEndTime = $input.data('timeType') === 'end';

                    if (selectedTime < currentTime) {
                        timeValidation.showError('Invalid Time', 'Selected time cannot be in the past');
                        $input.val('');
                        return false;
                    }

                    if (isEndTime && startTime && endTime <= startTime) {
                        timeValidation.showError('Invalid Time Range', 'End time must be after start time');
                        $input.val('');
                        return false;
                    }

                    return true;
                }
            };

            // Initialize the datetime pickers when the booking modal is shown
            $('#bookingModal').on('show.bs.modal', function () {
                // Initialize start time picker
                startTimePicker = $('#start-picker').dateTimePicker({
                    label: 'Starting On',
                    dateFormat: 'MM/DD/YYYY, h:mm A',
                    defaultDate: new Date(),
                    minuteInterval: 5,
                    onChange: function (date) {
                        $('#startTime').val(date.toISOString());
                        // Update end picker min date/time
                        if (endTimePicker && typeof endTimePicker.setMinDate === 'function') {
                            endTimePicker.setMinDate(date);
                        } else if ($('#end-picker').data('DateTimePicker')) {
                            $('#end-picker').data('DateTimePicker').minDate(date);
                        }
                        // If current end < new start, reset end picker
                        var endVal = $('#endTime').val();
                        if (endVal && new Date(endVal) <= date) {
                            $('#endTime').val('');
                            if (endTimePicker && typeof endTimePicker.clear === 'function') {
                                endTimePicker.clear();
                            }
                        }
                    }
                });

                // Initialize end time picker with default 1 hour later
                const defaultEndTime = new Date(new Date().getTime() + 60 * 60 * 1000);
                endTimePicker = $('#end-picker').dateTimePicker({
                    label: 'Ending On',
                    dateFormat: 'MM/DD/YYYY, h:mm A',
                    defaultDate: defaultEndTime,
                    minuteInterval: 5,
                    onChange: function (date) {
                        var startVal = $('#startTime').val();
                        if (startVal && new Date(date) <= new Date(startVal)) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Invalid Time Range',
                                text: 'End time must be after start time.'
                            });
                            $('#endTime').val('');
                            if (endTimePicker && typeof endTimePicker.clear === 'function') {
                                endTimePicker.clear();
                            }
                            return;
                        }
                        $('#endTime').val(date.toISOString());
                    }
                });

                // Set initial values
                $('#startTime').val(new Date().toISOString());
                $('#endTime').val(defaultEndTime.toISOString());
            });

            // The formatDateForColdFusion function has been moved to the global scope

            // Handle form submission for validation
            $('#bookingForm').on('submit', function (e) {
                const startTimeISO = $('#startTime').val();
                const endTimeISO = $('#endTime').val();
                const roomId = $('#roomSelect').val();
                const title = $('#bookingTitle').val();

                if (!startTimeISO || !endTimeISO) {
                    e.preventDefault();
                    Swal.fire({
                        icon: 'error',
                        title: 'Missing Information',
                        text: 'Please select both start and end times.'
                    });
                    return false;
                }

                // Validate that end time is after start time
                if (startTimeISO && endTimeISO) {
                    const startDate = new Date(startTimeISO);
                    const endDate = new Date(endTimeISO);

                    if (endDate <= startDate) {
                        e.preventDefault();
                        Swal.fire({
                            icon: 'error',
                            title: 'Invalid Time Range',
                            text: 'End time must be after start time.'
                        });
                        return false;
                    }

                    // Format dates for ColdFusion and update hidden fields
                    const formattedStartTime = formatDateForColdFusion(startTimeISO);
                    const formattedEndTime = formatDateForColdFusion(endTimeISO);

                    // Replace ISO format with formatted dates
                    $('#startTime').val(formattedStartTime);
                    $('#endTime').val(formattedEndTime);
                }

                if (!roomId || roomId === '') {
                    e.preventDefault();
                    Swal.fire({
                        icon: 'error',
                        title: 'Missing Information',
                        text: 'Please select a room.'
                    });
                    return false;
                }

                // Only validate title for non-focus rooms
                const selectedRoomText = $('#roomSelect option:selected').text();
                const isFocusRoom = selectedRoomText.includes('Focus Room');
                
                if (!isFocusRoom && (!title || title.trim() === '')) {
                    e.preventDefault();
                    Swal.fire({
                        icon: 'error',
                        title: 'Missing Information',
                        text: 'Please enter a title for your booking.'
                    });
                    return false;
                }
            });

            // Reset form when modal is hidden
            $('#bookingModal').on('hidden.bs.modal', function () {
                $('#bookingForm')[0].reset();
                $('#startTime').val('');
                $('#endTime').val('');
                $('#titleContainer').addClass('d-none');
                $('#bookingTitle').prop('required', false);
            });

            const bookingManager = {
                init() {
                    this.setupEventHandlers();
                    this.loadUserBookings();

                    // Check recurring status from database
                    // $.ajax({
                    //     url: 'cfcs/dashboard-data.cfc',
                    //     type: 'GET',
                    //     dataType: 'json',
                    //     data: {
                    //         method: 'getRecurringStatus',
                    //         returnformat: 'json'
                    //     },
                    //     success: function (response) {
                    //         if (response.STATUS === 'SUCCESS' && response.ROLE === 'ADMIN') {
                    //             $('#recurringDetailsContainer').show();
                    //         }
                    //     }
                    // });
                },

                loadUserBookings() {
                    const userId = getCurrentUserId();
                    if (!userId) {
                        console.warn('No user ID found in session');
                        return;
                    }

                    $.ajax({
                        url: 'cfcs/dashboard-data.cfc',
                        method: 'GET',
                        data: {
                            method: 'MyBookings',
                            userId: userId
                        },
                        dataType: 'json',
                        success: function (response) {
                            // Check if response exists
                            if (!response) {
                                console.error('Empty response received');
                                $('#userBookings').html('<div class="alert alert-danger">Error loading bookings</div>');
                                return;
                            }

                            // Handle success response with data property
                            if (response.status === 'success' || response.success) {
                                // Update the bookings display
                                const bookings = response.data || [];
                                $('#userBookings').empty();

                                // Handle empty bookings array
                                if (!bookings || bookings.length === 0) {
                                    $('#userBookings').append('<div class="alert alert-info">No upcoming bookings</div>');
                                    return;
                                }

                                try {
                                    const bookingsHtml = bookings.map(booking => {
                                        // Safely handle potentially missing properties
                                        const id = booking.ID || booking.id || '';
                                        const title = booking.TITLE || booking.title || 'Untitled Booking';
                                        const startTime = booking.START_TIME || booking.start_time || new Date().toISOString();
                                        const endTime = booking.END_TIME || booking.end_time || new Date().toISOString();
                                        const status = booking.STATUS || booking.status || 'PENDING';

                                        return `
                                            <div class="booking-item card mb-2" data-booking-id="${id}">
                                                <div class="card-body">
                                                    <h5 class="card-title">${title}</h5>
                                                    <div class="card-text">
                                                        <div class="booking-time">
                                                            <i class="fas fa-clock"></i> 
                                                            ${new Date(startTime).toLocaleString()} - 
                                                            ${new Date(endTime).toLocaleString()}
                                                        </div>
                                                        <div class="booking-status">
                                                            <span class="badge bg-${status === 'CONFIRMED' ? 'success' : 'warning'}">
                                                                ${status}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('');

                                    $('#userBookings').html(bookingsHtml);
                                } catch (err) {
                                    console.error('Error processing bookings data:', err);
                                    $('#userBookings').html('<div class="alert alert-warning">Error processing booking data</div>');
                                }
                            } else {
                                console.error('Error loading bookings:', response);
                                $('#userBookings').html('<div class="alert alert-danger">Error loading bookings</div>');
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error('AJAX error:', error);
                            $('#userBookings').html('<div class="alert alert-danger">Error loading bookings</div>');
                        }
                    });
                },

                setupEventHandlers() {
                    // Initialize the booking modal
                    const bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));

                    // Handle new booking button click
                    $('.btn-new-booking').on('click', function () {
                        //reset form
                        $('#bookingForm')[0].reset();
                        $("#locationContainer").html('');
                        $("#capacityContainer").html('');
                        $(".amentiesContainer").html('');
                        $("#descriptionContainer").html('');
                        $("#recurringDetailsContainer").hide();
                        $('#selectedRoomImage').attr('src', 'assets/images/officePlaceholder.png')
                        $('#roomMapContainer').off('click');

                        // Load available rooms
                        $.ajax({
                            url: 'cfcs/dashboard-data.cfc',
                            method: 'GET',
                            data: {
                                method: 'getRooms'
                            },
                            dataType: 'json',

                            success: function (response) {

                                Swal.close();

                                const roomSelect = $('#roomSelect');
                                roomSelect.empty();
                                roomSelect.append('<option value="">Choose a room...</option>');

                                response.forEach(room => {
                                    //if room is booked disable it
                                    if (room.maintenance === 'YES' || room.active_status === 'Inactive') {
                                        roomSelect.append(`<option value="${room.id}" disabled>${room.roomName} </option>`);
                                    } else {
                                        roomSelect.append(`<option value="${room.id}" data-recurring="${room.recurring}">${room.roomName} </option>`);
                                    }
                                });

                                // Initially hide recurring container
                                $('#recurringDetailsContainer').hide();


                                // Add change event handler for room selection
                                roomSelect.off('change').on('change', async function () {
                                    const selectedRoom = $(this).val();
                                    const selectedOption = $(this).find(':selected');
                                    const allowsRecurring = selectedOption.data('recurring') === 'YES';
                                    const imgContainer = $('#roomImageContainer');
                                    const roomImg = $('#selectedRoomImage');
                                    const amenitiesContainer = $('#amenitiesContainer');
                                    const amenityIcons = $('#amenityIcons');
                                    const descriptionContainer = $('#descriptionContainer');


                                    // Handle recurring option
                                    if (allowsRecurring) {
                                        $('#recurringDetailsContainer').slideDown();
                                    } else {
                                        $('#recurringDetailsContainer').slideUp();
                                        $('#recurringDetails').val(''); // Reset recurring selection
                                    }

                                    // Show/hide title card for non-focus rooms with smooth transition
                                    const isFocusRoom = selectedOption.text().includes('Focus Room');
                                    const titleContainer = $('#titleContainer');

                                    if (!isFocusRoom) {
                                        titleContainer.slideDown(200, function () {
                                            $(this).removeClass('d-none');
                                            $('#bookingTitle').prop('required', true);
                                        });
                                    } else {
                                        titleContainer.slideUp(200, function () {
                                            $(this).addClass('d-none');
                                            $('#bookingTitle').prop('required', false);
                                        });
                                    }

                                    if (selectedRoom) {
                                        //fetch room amenities from database
                                        $.ajax({
                                            url: 'assets/cfc/amenity.cfc',
                                            type: 'GET',
                                            dataType: 'json',
                                            data: {
                                                method: 'getRoomAmenities',
                                                roomId: selectedRoom
                                            },
                                            success: function (response) {
                                                if (response) {
                                                    var html = '';
                                                    for (let i = 0; i < response.length; i++) {
                                                        html += "<i class='fas " + response[i].icon + " fa-2x me-2' data-amenity-id='" + response[i].id + "' data-bs-toggle='tooltip' data-bs-placement='bottom' title='" + response[i].name + "'></i>";
                                                    }
                                                    $(".amentiesContainer").html(html);
                                                    // Initialize tooltips
                                                    $('[data-bs-toggle="tooltip"]').tooltip();
                                                } else {
                                                    $('#amentiesContainer').html('');
                                                }

                                            },
                                            error: function (xhr, status, error) {
                                                console.error('Error loading room amenities:', error);
                                            }
                                        });
                                        // fetch room description from database
                                        $.ajax({
                                            url: 'cfcs/dashboard-data.cfc',
                                            type: 'GET',
                                            dataType: 'json',
                                            data: {
                                                method: 'getRoomDescription',
                                                roomId: selectedRoom
                                            },
                                            success: function (response) {
                                                if (response.DESCRIPTION) {
                                                    $('#descriptionContainer').html(response.DESCRIPTION);
                                                    $('#capacityContainer').html(response.CAPACITY);
                                                    $('#locationContainer').html(response.BUILDING + '.' + response.ROOM_NUMBER);


                                                    $('#roomMapContainer').on('click', function () {
                                                        Swal.fire({
                                                            imageUrl: "assets/images/maps/" + response.ROOM_NUMBER + ".png",
                                                            imageAlt: "Office Map"
                                                        });
                                                    });
                                                } else {
                                                    $('#descriptionContainer').html('');
                                                    $('#capacityContainer').html('');
                                                    $('#locationContainer').html('');
                                                    $('#roomMapContainer').off('click');
                                                }
                                            },
                                            error: function (xhr, status, error) {
                                                console.error('Error loading room description:', error);
                                            }
                                        });
                                        // Fetch room image from database
                                        $.ajax({
                                            url: 'cfcs/dashboard-data.cfc',
                                            type: 'GET',
                                            dataType: 'json',
                                            data: {
                                                method: 'getRoomImage',
                                                roomId: selectedRoom
                                            },
                                            beforeSend: function () {
                                                $('#roomImageContainer').removeClass('d-none');
                                                Swal.fire({
                                                    html: '<div class="card p-1 d-flex align-items-center justify-content-center"data-aos="zoom-in" data-aos-anchor-placement="top-bottom"><span class="fs-1">Loading Image <div class="spinner-border text-danger" role="status"></div></span></div>',
                                                    showConfirmButton: false,
                                                    allowOutsideClick: false
                                                });
                                            },
                                            success: function (response) {
                                                if (response && response.IMAGE_DATA) {
                                                    // Remove any duplicate base64 prefix
                                                    let imageData = response.IMAGE_DATA;
                                                    if (imageData.indexOf('data:image') !== imageData.lastIndexOf('data:image')) {
                                                        imageData = imageData.substring(imageData.lastIndexOf('data:image'));
                                                    }

                                                    $('#selectedRoomImage')
                                                        .attr('src', imageData)
                                                        .on('load', function () {
                                                            $(this).addClass('loaded');
                                                        })
                                                        .on('error', function () {
                                                            $(this).attr('src', 'assets/images/officePlaceholder.png');
                                                        });
                                                    $('#currentImage').val(imageData);
                                                } else {
                                                    $('#selectedRoomImage').attr('src', 'assets/images/officePlaceholder.png');
                                                    $('#currentImage').val('');
                                                }
                                                Swal.close();
                                            },
                                            error: function (xhr, status, error) {
                                                console.error('Error loading room image:', error);
                                                $('#selectedRoomImage').attr('src', 'assets/images/officePlaceholder.png');
                                                $('#currentImage').val('');
                                                showAlert('Failed to load room image', 'error');
                                            }
                                        });
                                    } else {
                                        imgContainer.addClass('d-none');
                                        roomImg.attr('src', 'assets/images/officePlaceholder.png');
                                        $('#currentImage').val('');
                                    }
                                });

                                // Show the modal
                                bookingModal.show();
                            },
                            error: function () {
                                showAlert('Error loading rooms. Please try again.', 'error');
                            }
                        });
                    });


                    // Handle modal shown event to set default values
                    $('#bookingModal').on('show.bs.modal', function () {
                        // Set default values for datetime inputs
                        const now = new Date();

                        // Round to nearest 15 minutes
                        const minutes = Math.ceil(now.getMinutes() / 15) * 15;
                        now.setMinutes(minutes, 0, 0);

                        // Create default end time (1 hour later)
                        const endTime = new Date(now);
                        endTime.setHours(endTime.getHours() + 1);

                        // Format for datetime-local input (YYYY-MM-DDThh:mm)
                        const formatDatetimeLocal = (date) => {
                            return date.getFullYear() + '-' +
                                String(date.getMonth() + 1).padStart(2, '0') + '-' +
                                String(date.getDate()).padStart(2, '0') + 'T' +
                                String(date.getHours()).padStart(2, '0') + ':' +
                                String(date.getMinutes()).padStart(2, '0');
                        };

                        // Set the values
                        $('#startTime').val(formatDatetimeLocal(now));
                        $('#endTime').val(formatDatetimeLocal(endTime));
                    });

                    // Handle modal hidden event to reset form
                    $('#bookingModal').on('hidden.bs.modal', function () {
                        $('#bookingForm')[0].reset();
                    });

                    // Handle recurring details visibility
                    $('#recurringDetails').on('change', function () {
                        const selectedValue = $(this).val();
                        if (selectedValue !== '') {
                            $('#recurringDetailsContainer').show();
                        } else {
                            $('#recurringDetailsContainer').hide();
                        }
                    });
                }
            };

            bookingManager.init();
        });
        // Alert function using SweetAlert2
        function showAlert(message, type = 'info') {
            Swal.fire({
                text: message,
                icon: type,
                position: 'top-end',
                showConfirmButton: false,
                timer: 1500,
                timerProgressBar: true
            });
        };

        // Make calendar and datetime picker variables globally accessible
        let globalCalendar;
        let startTimePicker = null;
        let endTimePicker = null;

        document.addEventListener('DOMContentLoaded', function () {
            let selectedRoomId = '';

            // Load top navigation based on user role
            if (sessionStorage.getItem('ROLE') === 'Admin' || sessionStorage.getItem('ROLE') === 'Site Admin') {
                $('#topNav').load('topNav-Admin.html', function () {
                    checkPendingApprovals();
                    checkNewUsers();
                });
            } else {
                $('#topNav').load('topNav-User.html');
            }

            // Function to populate room filter dropdown
            function populateRoomFilter() {
                $.ajax({
                    url: 'cfcs/dashboard-data.cfc',
                    method: 'GET',
                    data: {
                        method: 'getRooms'
                    },
                    dataType: 'json',
                    success: function (response) {
                        if (response && Array.isArray(response)) {
                            const $roomFilter = $('#roomFilter');
                            response.forEach(room => {
                                if (room.maintenance === 'YES') {
                                    $roomFilter.append(`<option value="${room.id}" disabled>${room.roomName}</option>`);
                                } else {
                                    $roomFilter.append(`<option value="${room.id}">${room.roomName}</option>`);
                                }
                            });
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Error fetching rooms:', error);
                    }
                });
            }

            // Handle room filter change
            $('#roomFilter').on('change', function () {
                selectedRoomId = $(this).val();
                globalCalendar.refetchEvents();
            });

            // Initialize FullCalendar
            var calendarEl = document.getElementById('upcomingBookings');
            if (calendarEl) {
                globalCalendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay'
                    },
                    height: 'auto',
                    nowIndicator: true,
                    navLinks: true,
                    editable: false,
                    dayMaxEvents: true,
                    events: function (fetchInfo, successCallback, failureCallback) {
                        console.log('Fetching calendar events...');
                        $.ajax({
                            url: 'cfcs/dashboard-data.cfc',
                            method: 'GET',
                            data: {
                                method: 'getAllBookings',
                                timestamp: new Date().getTime() // Add timestamp to prevent caching
                            },
                            dataType: 'json',
                            cache: false, // Prevent caching of results
                            success: function (response) {
                                console.log('Calendar events response:', response);
                                if (response.status === 'success' && Array.isArray(response.BOOKINGS)) {
                                    var events = response.BOOKINGS
                                        .filter(booking => !selectedRoomId || parseInt(booking.ROOM_ID) === parseInt(selectedRoomId))
                                        .map(function (booking) {
                                            // Parse start time components
                                            var startParts = booking.STARTTIME.match(/(\d+):(\d+)\s*(AM|PM)/i);
                                            if (!startParts) {
                                                console.error('Invalid start time format:', booking.STARTTIME);
                                                return null;
                                            }
                                            var startHours = parseInt(startParts[1]);
                                            var startMinutes = parseInt(startParts[2]);
                                            if (startParts[3].toUpperCase() === 'PM' && startHours < 12) startHours += 12;
                                            if (startParts[3].toUpperCase() === 'AM' && startHours === 12) startHours = 0;

                                            // Parse end time components
                                            var endParts = booking.ENDTIME.match(/(\d+):(\d+)\s*(AM|PM)/i);
                                            if (!endParts) {
                                                console.error('Invalid end time format:', booking.ENDTIME);
                                                return null;
                                            }
                                            var endHours = parseInt(endParts[1]);
                                            var endMinutes = parseInt(endParts[2]);
                                            if (endParts[3].toUpperCase() === 'PM' && endHours < 12) endHours += 12;
                                            if (endParts[3].toUpperCase() === 'AM' && endHours === 12) endHours = 0;

                                            var startDate = new Date(booking.STARTDATE + 'T' +
                                                startHours.toString().padStart(2, '0') + ':' +
                                                startMinutes.toString().padStart(2, '0') + ':00');

                                            var endDate = new Date(booking.ENDDATE + 'T' +
                                                endHours.toString().padStart(2, '0') + ':' +
                                                endMinutes.toString().padStart(2, '0') + ':00');

                                            return {
                                                id: booking.ID,
                                                title: booking.FIRSTNAME.charAt(0).toUpperCase() + '. ' + booking.LASTNAME + ' (' + booking.NAME + ')',
                                                start: startDate.toISOString(),
                                                end: endDate.toISOString(),
                                                extendedProps: {
                                                    roomId: booking.ROOM_ID,
                                                    roomName: booking.NAME,
                                                    description: booking.DESCRIPTION || 'No description available',
                                                    status: booking.STATUS || 'Pending',
                                                    userId: booking.USERID
                                                },
                                                className: [
                                                    `room-${(booking.ID % 10) + 1}`,
                                                    `booking-status-${(booking.STATUS || 'pending').toLowerCase()}`
                                                ]
                                            };
                                        }).filter(Boolean);
                                    successCallback(events);
                                } else {
                                    failureCallback('Invalid response format');
                                }
                            },
                            error: function (xhr, status, error) {
                                failureCallback(error);
                            }
                        });
                    },
                    eventContent: function (info) {
                        const roomClass = info.event.classNames.find(className => className.startsWith('room-'));
                        return {
                            html: `
                                <div class="fc-event-main ${roomClass}">
                                    <div class="fc-event-time">${info.timeText}</div>
                                    <div class="fc-event-title">
                                        <span class="status-dot status-dot-${info.event.extendedProps.status.toLowerCase()}"></span>
                                        ${info.event.title}
                                    </div>
                                </div>
                            `
                        };
                    },
                    eventDidMount: function (info) {
                        // change Format dates to not include seconds in format and date format to mm/dd/yyyy 
                        const startStr = new Date(info.event.start).toLocaleString(undefined, { year: 'numeric', month: 'numeric', day: 'numeric', hour: 'numeric', minute: '2-digit' });
                        const endStr = new Date(info.event.end).toLocaleString(undefined, { year: 'numeric', month: 'numeric', day: 'numeric', hour: 'numeric', minute: '2-digit' });

                        // Add tooltip
                        $(info.el).tooltip({
                            title: `${info.event.title}<br>From: ${startStr}<br>Until: ${endStr}`,
                            placement: 'top',
                            container: 'body',
                            html: true
                        });
                    },
                    eventClick: function (info) {
                        // Format dates
                        const startStr = info.event.start ? new Date(info.event.start).toLocaleString(undefined, { year: 'numeric', month: 'numeric', day: 'numeric', hour: 'numeric', minute: '2-digit' }) : 'Not specified';
                        const endStr = info.event.end ? new Date(info.event.end).toLocaleString(undefined, { year: 'numeric', month: 'numeric', day: 'numeric', hour: 'numeric', minute: '2-digit' }) : 'Not specified';

                        // Check if current user is the creator or an admin
                        const currentUserId = getCurrentUserId();
                        const userRole = sessionStorage.getItem('ROLE');
                        const isCreator = info.event.extendedProps.userId == currentUserId;
                        const isAdmin = userRole === 'Admin' || userRole === 'Site Admin';


                        Swal.fire({
                            title: `Booking Details (ID: ${info.event.id})`,
                            html: `
                                <div class="booking-details text-start">
                                    <p><strong>Room:</strong> ${info.event.extendedProps.roomName || 'Not specified'}</p>
                                    <p><strong>Description:</strong> ${info.event.extendedProps.description || 'No description'}</p>
                                    <p><strong>Starting On:</strong> ${startStr}</p>
                                    <p><strong>Ending On:</strong> ${endStr}</p>
                                    <p class="text-capitalize"><strong>Status:</strong> ${info.event.extendedProps.status}</p>
                                </div>
                            `,
                            showCancelButton: true,
                            showConfirmButton: isCreator || isAdmin,
                            confirmButtonText: 'Cancel Booking',
                            cancelButtonText: 'Close',
                            showLoaderOnConfirm: true,
                            preConfirm: () => {
                                return new Promise((resolve, reject) => {
                                    if (!info.event.id) {
                                        reject('No booking ID found');
                                        return;
                                    }
                                    if (!isCreator && !isAdmin) {
                                        reject('You do not have permission to cancel this booking');
                                        return;
                                    }
                                    cancelBooking(info.event.id)
                                        .then(resolve)
                                        .catch(reject);
                                });
                            }
                        }).then((result) => {
                            if (result.isConfirmed) {
                                globalCalendar.refetchEvents();
                                checkPendingApprovals();
                                Swal.fire('Cancelled!', 'The booking has been cancelled.', 'success');
                            }
                        }).catch(error => {
                            console.error('Error:', error);
                            // Convert error object to string if needed
                            const errorMessage = (typeof error === 'object') ? 'Failed to cancel booking. Please try again.' : error || 'Failed to cancel booking. Please try again.';
                            Swal.fire('Error', errorMessage, 'error');
                        });
                    }
                });
                globalCalendar.render();
                populateRoomFilter(); // Populate room filter after calendar initialization
            }

            // Handle save booking button click
            $('#saveBooking').on('click', function () {
                const roomId = $('#roomSelect').val();
                const startTimeInput = $('#startTime').val();
                const endTimeInput = $('#endTime').val();
                const recurringDetails = $('#recurringDetails').val();
                const userId = getCurrentUserId();

                // Get the date values directly from the datetime-local inputs
                const startTimeRaw = $('#startTime').val();
                const endTimeRaw = $('#endTime').val();

                if (!roomId || !startTimeRaw || !endTimeRaw || !userId) {
                    showAlert('Please fill in all required fields', 'warning');
                    return;
                }

                // Format dates for ColdFusion
                const startTime = formatDateForColdFusion(startTimeRaw);
                const endTime = formatDateForColdFusion(endTimeRaw);

                // For date calculations, use the original date objects
                const startDate = new Date(startTimeRaw);
                const endDate = new Date(endTimeRaw);
                const isMultiDay = startDate.getDate() !== endDate.getDate() ||
                    startDate.getMonth() !== endDate.getMonth() ||
                    startDate.getFullYear() !== endDate.getFullYear();

                // Validate booking duration (max 7 days)
                const durationMs = endDate - startDate;
                const durationDays = durationMs / (1000 * 60 * 60 * 24);

                if (durationDays > 7) {
                    showAlert('Maximum booking duration is 7 days', 'warning');
                    return;
                }

                // Get meeting title if it's a non-focus room
                const selectedRoom = $('#roomSelect option:selected').text();
                const isFocusRoom = selectedRoom.includes('Focus Room');
                const meetingTitle = !isFocusRoom ? $('#bookingTitle').val().trim() : '';
                
                // Show loading indicator
                Swal.fire({
                    title: 'Creating Booking...',
                    text: 'Please wait while we process your request.',
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Create booking
                $.ajax({
                    url: 'cfcs/dashboard-data.cfc',
                    method: 'POST',
                    data: {
                        method: 'createBooking',
                        employee_id: sessionStorage.getItem('EMPLID'),
                        user_id: sessionStorage.getItem('USER_ID'),
                        room_id: $('#roomSelect').val(),
                        start_time: startTime,
                        end_time: endTime,
                        is_multi_day: isMultiDay ? 1 : 0,
                        recurring_details: $('#recurringDetails').val(),
                        comments: meetingTitle || ''
                    },
                    dataType: 'json',
                    timeout: 30000, // 30 second timeout
                    success: function (response) {
                        Swal.close(); // Close loading indicator
                        
                        if (response.status === 'success') {
                            checkPendingApprovals()
                            // First hide the modal
                            $('#bookingModal').modal('hide');
                            
                            // Reset the form inputs
                            $('#bookingForm')[0].reset();
                            
                            // Reset title field and hide the container
                            $('#bookingTitle').val('');
                            $('#titleContainer').addClass('d-none');

                            // Re-initialize the pickers on next modal open
                            $('#start-picker, #end-picker').empty();
                            $('#roomSelect').val('');
                            $('#recurringDetails').val('');

                            // Show success message
                            Swal.fire({
                                icon: 'success',
                                title: 'Booking Created Successfully!',
                                text: response.data.message || 'Your booking has been created and is pending approval.',
                                timer: 3000,
                                timerProgressBar: true,
                                showConfirmButton: true
                            });

                            // Refresh calendar and bookings list with a delay to ensure server has processed the booking
                            setTimeout(function () {
                                globalCalendar.refetchEvents();
                                bookingManager.loadUserBookings();
                                checkPendingApprovals();
                            }, 1000);
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Booking Failed',
                                text: response.data.message || response.message || 'Error creating booking. Please try again.',
                                showConfirmButton: true
                            });
                        }
                    },
                    error: function (xhr, status, error) {
                        Swal.close(); // Close loading indicator
                        
                        let errorMessage = 'Error creating booking. Please try again.';
                        
                        if (status === 'timeout') {
                            errorMessage = 'The request timed out. Please check your connection and try again.';
                        } else if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        } else if (error) {
                            errorMessage = 'Error: ' + error;
                        }
                        
                        Swal.fire({
                            icon: 'error',
                            title: 'Booking Failed',
                            text: errorMessage,
                            showConfirmButton: true
                        });
                    }
                });
            });

            // Cancel booking function
            function cancelBooking(bookingId) {
                return new Promise((resolve, reject) => {
                    $.ajax({
                        url: 'cfcs/dashboard-data.cfc?method=cancelBooking',
                        method: 'POST',
                        dataType: 'json',
                        data: {
                            bookingId: bookingId,
                            userId: sessionStorage.getItem('USER_ID'),
                        },
                        success: function (response) {
                            if (response.status === 'SUCCESS') {
                                // reload approval count on dashboard
                                getTotalBookings();

                                Swal.fire({
                                    icon: 'success',
                                    title: 'Success',
                                    text: 'Booking cancelled successfully'
                                });
                                resolve(response);
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: response.MESSAGE || 'Failed to cancel booking'
                                });
                                reject(response);
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error('Error cancelling booking:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'Failed to cancel booking'
                            });
                            reject(error);
                        }
                    });
                });
            }

            // Logout function
            function handleLogout() {
                window.location.href = 'logout.html';
            }

            // Function to get total rooms
            function getTotalRooms() {
                $.ajax({
                    url: 'cfcs/dashboard-data.cfc?method=availableRooms',
                    method: 'GET',
                    dataType: 'json',
                    success: function (response) {
                        $('#availableRooms').text(response.data.totalAvailableRooms || '0');
                    },
                    error: function (error) {
                        console.error('Error getting total rooms:', error);
                        $('#availableRooms').text('0');
                    }
                });
            }

            // Function to get total History
            function getTotalMeetings() {
                $.ajax({
                    url: 'cfcs/dashboard-data.cfc?method=totalMeetings',
                    method: 'GET',
                    dataType: 'json',
                    data: {
                        userId: sessionStorage.getItem('USER_ID')
                    },
                    success: function (response) {
                        //console.log(response.data.TOTAL);
                        $('#myHistory').text(response.data.TOTAL || '00');
                    },
                    error: function (error) {
                        console.error('Error getting total meetings:', error);
                        $('#myHistory').text('0');
                    }
                });
            }

            // Function to get total bookings
            function getTotalBookings() {
                $.ajax({
                    url: 'cfcs/dashboard-data.cfc?method=todayBookings',
                    method: 'GET',
                    dataType: 'json',
                    data: {
                        userId: sessionStorage.getItem('USER_ID')
                    },
                    success: function (response) {
                        $('#myBookings').text(response.data.TOTAL || '0');
                    },
                    error: function (error) {
                        console.error('Error getting total bookings:', error);
                        $('#myBookings').text('0');
                    }
                });
            }

            function loadAvailableRooms() {
                $.ajax({
                    url: 'cfcs/dashboard-data.cfc?method=availableRooms',
                    method: 'GET',
                    dataType: 'json',
                    success: function (response) {
                        if (response.status === 'success') {
                            const rooms = response.data;
                            const roomSelect = $('#roomSelect');
                            roomSelect.empty();
                            rooms.forEach(room => {
                                roomSelect.append($('<option>', {
                                    value: room.ID,
                                    text: room.NAME
                                }));
                            });
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Error fetching available rooms:', error);
                    }
                });
            }

            function checkPendingApprovals() {
                $.ajax({
                    url: './assets/cfc/approvals.cfc',
                    type: 'GET',
                    data: {
                        method: 'getPendingApprovalsCount'
                    },
                    success: function (response) {
                        const count = parseInt(response);
                        const badge = $('#pendingApprovalsBadge');
                        if (count > 0) {
                            badge.text(count).removeClass('d-none');
                        } else {
                            badge.addClass('d-none');
                        }
                    }
                });
            }
        });
        // Helper function to get current user ID
        function getCurrentUserId() {
            return sessionStorage.getItem('USER_ID');
        }

        // Function to check user role
        function checkUserRole() {
            $.ajax({
                url: 'assets/cfc/user.cfc',
                type: 'GET',
                data: {
                    method: 'getUserRole',
                    returnformat: 'json'
                },
                success: function (response) {
                    if (response.STATUS === 'SUCCESS' && response.ROLE === 'ADMIN') {
                        $('.admin-only').show();
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error checking user role:', error);
                }
            });
        }
    </script>
</body>

</html>